<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaPlay</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap Modal -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        :root {
            --bg-primary: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #0f172a 100%);
            --bg-secondary: #1e293b;
            --bg-tertiary: #0f172a;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --border-color: rgba(255,255,255,0.1);
            --card-bg: rgba(30, 41, 59, 0.7);
            --input-bg: #1b2838;
            --input-border: #3b4450;
            --input-focus-bg: #0f1926;
            --input-focus-border: #67c1f5;
            --modal-bg: #1b2838;
            --modal-border: #2a3f55;
            --nav-bg: rgba(15,23,42,0.95);
            --nav-border: rgba(255,255,255,0.1);
        }

        [data-theme="light"] {
            --bg-primary: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f8fafc 100%);
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: rgba(0,0,0,0.1);
            --card-bg: rgba(255, 255, 255, 0.9);
            --input-bg: #ffffff;
            --input-border: #cbd5e1;
            --input-focus-bg: #f8fafc;
            --input-focus-border: #3b82f6;
            --modal-bg: #ffffff;
            --modal-border: #e2e8f0;
            --nav-bg: rgba(255,255,255,0.95);
            --nav-border: rgba(0,0,0,0.1);
        }

        body {
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
        }

        .card-hover {
            transition: transform 0.3s ease;
        }

        .card-hover:hover {
            transform: scale(1.05);
        }

        /* Game description bar (non-covering) shown below the image on hover */
        .card-hover { position: relative; overflow: visible; }
        .game-desc-bar {
            background: rgba(2,6,23,0.6);
            color: var(--text-secondary);
            padding: 8px 10px;
            box-sizing: border-box;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            line-height: 1.15rem;
            max-height: 5rem;
            overflow: hidden;
            opacity: 0;
            transform: translateY(6px);
            transition: opacity 0.18s ease, transform 0.18s ease;
            margin-bottom: 8px;
            border: 1px solid rgba(255,255,255,0.04);
            backdrop-filter: blur(6px);
        }

        .card-hover:hover .game-desc-bar {
            opacity: 1;
            transform: translateY(0);
        }

        .game-desc-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: center;
            max-height: 4.8rem;
            overflow: hidden;
        }

        .nav-gradient {
            background: linear-gradient(to right, #3b82f6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* FIXED INPUT CLASS */
        .steam-input {
            background: var(--input-bg) !important;
            border: 1px solid var(--input-border) !important;
            color: var(--text-primary) !important;
            padding: 14px 16px !important;
            font-size: 16px !important;
            border-radius: 6px !important;
        }

        .steam-input:focus {
            background: var(--input-focus-bg) !important;
            border-color: var(--input-focus-border) !important;
            box-shadow: 0 0 6px rgba(59, 130, 246, 0.5) !important;
            color: var(--text-primary) !important;
        }

        .modal-content {
            background: var(--modal-bg) !important;
            border: 1px solid var(--modal-border) !important;
        }

        /* Theme-aware overrides for common text utility classes */
        [data-theme="light"] .text-white,
        [data-theme="light"] .text-white-50 {
            color: var(--text-primary) !important;
        }

        /* Keep navbar and card text dark (readable) in light theme */
        [data-theme="light"] .navbar, [data-theme="light"] .navbar *,
        [data-theme="light"] .card-hover, [data-theme="light"] .card-hover *,
        [data-theme="light"] .bg-slate-700, [data-theme="light"] .bg-slate-700 * {
            color: #ffffff !important;
        }

        [data-theme="light"] .text-gray-400,
        [data-theme="light"] .text-gray-300,
        [data-theme="light"] .text-gray-500,
        [data-theme="light"] .text-gray-600 {
            color: var(--text-secondary) !important;
        }

        [data-theme="light"] .text-blue-400 { color: #1d4ed8 !important; }
        [data-theme="light"] .text-yellow-400 { color: #b7791f !important; }

        .modal-header,
        .modal-footer {
            border-color: var(--modal-border) !important;
        }

        .modal-footer {
            display: block;
            text-align: center;
        }

        /* LOGIN BUTTON FIXED */
        .login-btn {
            width: 100%;
            padding: 14px 16px;
            background: linear-gradient(to right, #3b82f6, #06b6d4);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 17px;
            transition: 0.2s;
        }

        .login-btn:hover {
            transform: scale(1.03);
            background: linear-gradient(to right, #2563eb, #0ea5e9);
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }

        .theme-toggle:hover {
            background: var(--bg-secondary);
        }
    </style>
</head>


<body class="text-white">

    <!-- Bootstrap CSS (REQUIRED for modal) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Navigation Bar -->
    <nav class="bg-slate-800 bg-opacity-95 border-b border-blue-500 border-opacity-20 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-8">
                    <h1 class="text-2xl font-bold nav-gradient">NovaPlay</h1>

                    <div class="hidden md:flex space-x-6">
                        <button onclick="showPage('store')"
                            class="nav-btn px-3 py-2 rounded transition text-gray-300 hover:text-white hover:bg-slate-700 bg-blue-600"
                            data-page="store">Store</button>
                        <button onclick="showPage('library')"
                            class="nav-btn px-3 py-2 rounded transition text-gray-300 hover:text-white hover:bg-slate-700"
                            data-page="library">Library</button>
                        <button id="adminNavBtn" onclick="showPage('admin')"
                            class="nav-btn px-3 py-2 rounded transition text-gray-300 hover:text-white hover:bg-slate-700"
                            data-page="admin" style="display:none;">Admin Panel</button>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <div class="relative hidden sm:block">
                        <input type="text" id="searchInput" placeholder="Search games..." onkeyup="filterGames()"
                            class="pl-10 pr-4 py-2 bg-slate-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-64">
                    </div>

                    <button onclick="showPage('cart')"
                        class="relative p-2 text-gray-300 hover:text-white hover:bg-slate-700 rounded-lg transition">
                        <span class="text-2xl">üõí</span>
                        <span id="cartBadge"
                            class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 items-center justify-center"
                            style="display:none;">0</span>
                    </button>

                    <div id="userSection" class="items-center space-x-3" style="display:none;">
                       <button id="userEmail"
                            class="text-gray-300 hidden sm:inline-flex items-center px-3 py-1 rounded hover:bg-slate-700"
                            type="button" onclick="showPage('profile')"></button>
                        <button onclick="logout()"
                            class="p-2 text-gray-300 hover:text-white hover:bg-slate-700 rounded-lg transition">Logout</button>
                    </div>

                    <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                        üåô
                    </button>

                    <button id="navLoginBtn" onclick="showLogin()"
                        class="p-2 text-gray-300 hover:text-white hover:bg-slate-700 rounded-lg transition">
                        Login
                    </button>
                </div>
            </div>
        </div>
    </nav>


    <!-- LOGIN MODAL FIXED -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title text-white">Sign in to NovaPlay</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input id="username" class="steam-input w-full mb-3" placeholder="Username">
                    <input id="password" type="password" class="steam-input w-full" placeholder="Password">

                    <div class="text-gray-400 text-sm mt-3">
                        <p>Admin: admin / admin</p>
                        <p>User: user / user</p>
                    </div>

                    <div id="loginMessage" class="text-red-400 mt-3 hidden">Invalid login</div>
                </div>

                <div class="modal-footer">
                    <!-- data-bs-dismiss="modal"   LAGI COBA REMOVE INI DARI BUTTON LOGIN -->
                    <button class="login-btn" onclick="login()">Login</button>
                </div>

            </div>
        </div>
    </div>
                <!-- PREVIEW MODAL -->
               <div class="modal fade" id="previewModal" tabindex="-1">
                   <div class="modal-dialog modal-dialog-centered">
                       <div class="modal-content">
                           <div class="modal-header">
                               <h5 id="previewTitle" class="modal-title text-white">Game Title</h5>
                               <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                           </div>
                           <div class="modal-body">
                               <img id="previewImage" src="" alt="" class="w-full h-48 object-cover rounded-md mb-3">
                               <div class="d-flex justify-content-between align-items-center mb-2">
                                   <div class="text-sm text-white-50">Publisher: <span id="previewPublisher" class="text-white fw-bold"></span></div>
                                   <div id="previewRating" class="text-yellow-400"></div>
                               </div>
                               <p id="previewDesc" class="text-gray-300 mb-2"></p>
                               <p id="previewPrice" class="font-bold text-blue-400 mb-3"></p>

                               <div>
                                   <h6 class="text-white mb-2">Reviews</h6>
                                   <div id="previewReviews" class="space-y-3 text-sm text-white-50">
                                       <!-- reviews injected here -->
                                   </div>
                               </div>
                           </div>
                           <div class="modal-footer">
                               <button id="previewAddBtn" class="login-btn">Add to Cart</button>
                           </div>
                       </div>
                   </div>
               </div>
    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Store Page -->
        <div id="storePage" class="page">
            <h2 class="text-3xl font-bold text-white mb-8">Featured Games</h2>

            <!-- Responsive Grid: Mobile (2 cols) ‚Üí Tablet (3 cols) ‚Üí Desktop (4 cols) -->
            <div id="gamesTable" class="bg-slate-800 rounded-xl p-4">
                <div id="gamesGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 items-stretch">
                    <!-- cards injected here -->
                </div>
            </div>
        </div>

        <!-- Library Page -->
        <div id="libraryPage" class="page" style="display:none;">
            <h2 class="text-3xl font-bold text-white mb-8">My Library</h2>
            <div class="text-center py-20">
                <p class="text-gray-400 text-lg">Your purchased games will appear here</p>
            </div>
        </div>

        <!-- Cart Page -->
        <div id="cartPage" class="page" style="display:none;">
            <h2 class="text-3xl font-bold text-white mb-8">Shopping Cart</h2>
            <div id="cartItems"></div>
            <div id="emptyCart" class="text-center py-20">
                <div class="text-6xl mb-4">üõí</div>
                <p class="text-gray-400 text-lg">Your cart is empty</p>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="adminPage" class="page" style="display:none;">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-white">Admin Panel</h2>
                <button onclick="showAddGameForm()"
                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition flex items-center space-x-2">
                    <span>‚ûï</span>
                    <span>Add Game</span>
                </button>
            </div>

            <div id="gameForm" class="bg-slate-800 rounded-xl p-6 mb-8" style="display:none;">
                <h3 id="formTitle" class="text-xl font-bold text-white mb-4">Add New Game</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-300 mb-2">Title</label>
                        <input type="text" id="gameTitle"
                            class="w-full px-4 py-2 bg-slate-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-300 mb-2">Price</label>
                            <input type="number" id="gamePrice" step="0.01"
                                class="w-full px-4 py-2 bg-slate-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-gray-300 mb-2">Genre</label>
                            <input type="text" id="gameGenre"
                                class="w-full px-4 py-2 bg-slate-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-300 mb-2">Description</label>
                        <textarea id="gameDescription" rows="3"
                            class="w-full px-4 py-2 bg-slate-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <div>
                        <label class="block text-gray-300 mb-2">Image URL</label>
                        <input type="url" id="gameImage"
                            class="w-full px-4 py-2 bg-slate-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="flex space-x-3">
                        <button onclick="saveGame()"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition">Save
                            Game</button>
                        <button onclick="cancelGameForm()"
                            class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg transition">Cancel</button>
                    </div>
                </div>
            </div>

            <div id="adminGamesList" class="space-y-4"></div>
        </div>
    </div>


    <!-- Bootstrap JS (REQUIRED for modal) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Modal Trigger -->
    <script>
        function showLogin() {
            let modal = new bootstrap.Modal(document.getElementById("loginModal"));
            modal.show();
        }
        // Showpage function to switch between pages
        function showPage(page) {
            const pageIds = ['store', 'library', 'cart', 'admin','profile'];
            // Toggle page visibility

            if (page === 'library') {
                const username = localStorage.getItem('username');
                const userId = localStorage.getItem('userId');
                if (!username || !userId) {
                    alert('Please login to view your library');
                    showLogin();
                    return;
                }
                window.location.href = 'library.html';
                return;
            }
            if (page === 'cart') {
                const username = localStorage.getItem('username');
                const userId = localStorage.getItem('userId');
                if (!username || !userId) {
                    alert('Please login to view your cart');
                    showLogin();
                    return;
                }
                window.location.href = 'Cart.html';
                return;
            }
            if (page === 'profile') {
                window.location.href = 'profile.html';
                return;
            }

            pageIds.forEach(p => {
                const el = document.getElementById(p + 'Page');
                if (!el) return;
                el.style.display = (p === page) ? 'block' : 'none';
            });

            // Update nav button active styles
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-300');
            });
            const activeBtn = document.querySelector(`.nav-btn[data-page="${page}"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-blue-600', 'text-white');
                activeBtn.classList.remove('text-gray-300');
            }

            // Page-specific actions
            if (page === 'store') {
                loadStore();
            }
            if (page === 'admin') {
                const userRole = localStorage.getItem('userRole');
                if (userRole === 'admin') {
                    loadAdminPanel();
                } else {
                    alert('Admin access required');
                    showPage('store');
                }
            }



            // Scroll to top for better UX
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }        
        /* LOAD GAME DUMMY VIA AJAX */
        function loadStore() {
            $.ajax({
                url: "game.php",
                method: "GET",
                dataType: "json",
                success: function (res) {
                    // Keep a client-side copy for admin UI
                    window.games = res;
                    $("#gamesGrid").empty();

                    res.forEach(g => {
                        // each row is a responsive "card" ‚Äî full card on mobile, grid row on md+
                        $("#gamesGrid").append(`
                        <div class="bg-slate-700 rounded-lg p-4 flex flex-col h-full card-hover">
                            <img src="${g.image || ''}" alt="${g.title}" class="w-full h-36 object-cover rounded-md mb-3">
                            <div class="game-desc-bar">${(g.description || '').replace(/`/g, '\`')}</div>
                            <h4 class="text-lg font-semibold text-white mb-1">${g.title}</h4>
                            <p class="text-sm text-gray-400 mb-2">${g.genre || ''}</p>
                            <p class="text-blue-400 font-bold mb-3">$${parseFloat(g.price || 0).toFixed(2)}</p>
                            <div class="mt-auto flex items-center justify-between">
                                <button onclick="previewGame('${encodeURIComponent(g.title)}')" class="px-3 py-1 bg-slate-600 hover:bg-slate-500 rounded text-sm">Preview</button>
                                <button onclick="addToCart(${g.id || 0})" class="px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded text-sm text-white">Add to Cart</button>
                            </div>
                        </div>
                `);
                    });

                    checkOwnershipForGames();
                    },
                error: function (xhr, status, err) {
                    console.error("Failed to load games:", status, err);
                    $("#gamesGrid").html('<div class="text-center text-red-400 col-span-2 md:col-span-4">Could not load games. Check games.php</div>');
                }
            });
        }

        /* --- ADMIN UI HELPERS --- */
        function loadAdminPanel() {
            const adminList = $("#adminGamesList");
            adminList.empty();
            const list = Array.isArray(window.games) ? window.games : [];
            list.forEach(game => {
                adminList.append(`
                    <div class="bg-slate-800 rounded-lg p-4 flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            <img src="${game.image || ''}" class="w-20 h-20 object-cover rounded" alt="${game.title}">
                            <div>
                                <h4 class="font-bold">${game.title}</h4>
                                <p class="text-gray-400 text-sm">${game.genre || ''} - $${parseFloat(game.price||0).toFixed(2)}</p>
                            </div>
                        </div>
                        <div class="space-x-2">
                            <button onclick="editGame(${game.id})" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">Edit</button>
                            <button onclick="deleteGame(${game.id})" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg">Delete</button>
                        </div>
                    </div>
                `);
            });
        }

        function showAddGameForm() {
            $("#gameForm").show();
            $("#formTitle").text("Add New Game");
            clearGameForm();
        }

        function cancelGameForm() {
            $("#gameForm").hide();
            clearGameForm();
        }

        function clearGameForm() {
            $("#gameTitle").val("");
            $("#gamePrice").val("");
            $("#gameGenre").val("");
            $("#gameDescription").val("");
            $("#gameImage").val("");
        }

        async function saveGame() {
            const title = $("#gameTitle").val().trim();
            const price = parseFloat($("#gamePrice").val());
            const genre = $("#gameGenre").val().trim();
            const description = $("#gameDescription").val().trim();
            const image = $("#gameImage").val().trim();
            
            if (!title || !price || !genre || !description || !image) {
                alert("Please fill all fields");
                return;
            }

            const payload = { title, price, genre, description, image };
            // Admin token - must match server's token in game.php
            try {
                // Ensure we have an admin token (may prompt for password)
                const token = await ensureAdminToken();
                const resp = await fetch('game.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Admin-Token': token },
                    body: JSON.stringify(payload)
                });

                const json = await resp.json().catch(() => null);
                if (resp.ok && json && json.success) {
                    // Refresh store and admin list from server
                    await loadStore();
                    loadAdminPanel();
                    cancelGameForm();
                    alert('Game added successfully!');
                    return;
                }

                console.warn('Server add failed', resp.status, json);
                alert('Server did not persist the game. It will be added locally for this session.');
            } catch (err) {
                console.error('Error saving game to server:', err);
                alert('Error contacting server. Game will be added locally for this session.');
            }

            // Fallback: add locally to client-side list
            const localId = (Array.isArray(window.games) ? window.games.length : 0) + 1;
            const newGameLocal = { id: localId, title, price, genre, description, image };
            window.games = Array.isArray(window.games) ? window.games.concat([newGameLocal]) : [newGameLocal];
            // update UI
            loadStore();
            loadAdminPanel();
            cancelGameForm();
        }

        // Ensure admin token in sessionStorage; if missing, prompt for password and request token
        async function ensureAdminToken() {
            let token = sessionStorage.getItem('admin_token');
            if (token) return token;

            // ask admin for password (simple prompt for demo). In real app, use modal form.
            const username = localStorage.getItem('username') || 'admin';
            const pwd = prompt('Enter admin password to perform this action:');
            if (!pwd) throw new Error('Admin password required');

            // request token from server
            const resp = await fetch('get_admin_token.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, password: pwd })
            });

            if (!resp.ok) {
                const j = await resp.json().catch(() => null);
                throw new Error(j && j.message ? j.message : 'Failed to obtain admin token');
            }
            const json = await resp.json();
            if (!json.success || !json.token) throw new Error('Token not returned');
            token = json.token;
            // keep in sessionStorage for this browser session
            sessionStorage.setItem('admin_token', token);
            return token;
        }

        async function deleteGame(gameId) {
            if (!confirm('Are you sure you want to delete this game?')) return;
            try {
                const token = await ensureAdminToken();
                const resp = await fetch('game.php?id=' + encodeURIComponent(gameId), {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', 'X-Admin-Token': token }
                });
                const json = await resp.json().catch(() => null);
                if (resp.ok && json && json.success) {
                    await loadStore();
                    loadAdminPanel();
                    alert('Game deleted');
                    return;
                }
                console.warn('Delete failed', resp.status, json);
                alert('Could not delete on server; removing locally for this session.');
            } catch (e) {
                console.error('Delete error', e);
                alert('Could not contact server; removing locally for this session.');
            }

            // Fallback local removal
            window.games = (window.games || []).filter(g => Number(g.id) !== Number(gameId));
            loadStore();
            loadAdminPanel();
        }

        function editGame(gameId) {
            const game = (window.games || []).find(g => Number(g.id) === Number(gameId));
            if (game) {
                $("#gameTitle").val(game.title);
                $("#gamePrice").val(game.price);
                $("#gameGenre").val(game.genre);
                $("#gameDescription").val(game.description);
                $("#gameImage").val(game.image);
                $("#gameForm").show();
                $("#formTitle").text("Edit Game");

                // Replace save button temporarily to perform update
                const saveBtn = $("#gameForm button").first();
                saveBtn.off('click');
                saveBtn.on('click', async function () {
                    // perform PUT request
                    const payload = {
                        id: gameId,
                        title: $("#gameTitle").val().trim(),
                        price: parseFloat($("#gamePrice").val()),
                        genre: $("#gameGenre").val().trim(),
                        description: $("#gameDescription").val().trim(),
                        image: $("#gameImage").val().trim()
                    };
                    try {
                        const token = await ensureAdminToken();
                        const resp = await fetch('game.php', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json', 'X-Admin-Token': token },
                            body: JSON.stringify(payload)
                        });
                        const json = await resp.json().catch(() => null);
                        if (resp.ok && json && json.success) {
                            await loadStore();
                            loadAdminPanel();
                            cancelGameForm();
                            alert('Game updated');
                        } else {
                            console.warn('Update failed', resp.status, json);
                            alert('Update failed on server; changes applied locally for this session.');
                            // apply locally
                            window.games = (window.games || []).map(g => g.id === gameId ? Object.assign({}, g, payload) : g);
                            loadStore();
                            loadAdminPanel();
                            cancelGameForm();
                        }
                    } catch (e) {
                        console.error('Update error', e);
                        alert('Could not contact server; changes applied locally for this session.');
                        window.games = (window.games || []).map(g => g.id === gameId ? Object.assign({}, g, payload) : g);
                        loadStore();
                        loadAdminPanel();
                        cancelGameForm();
                    } finally {
                        // restore save button click to default add behavior
                        saveBtn.off('click');
                        saveBtn.on('click', saveGame);
                    }
                });
            }
        }
        
        /* DATA LOGIN VIA AJAX */
        function login() {
            let username = $("#username").val().trim();
            let password = $("#password").val().trim();

            // Validate input
            if (!username || !password) {
                $("#loginMessage").text("Please enter username and password").removeClass("hidden");
                return;
            }



            // Hide previous error messages
            $("#loginMessage").addClass("hidden");

            $.ajax({
                url: "login.php",
                method: "POST",
                dataType: "json",
                data: {
                    username: username,
                    password: password
                },
                success: function (res) {
                    console.log("Login Response:", res); // Debug

                    if (res.success) {
                        // Store user info in localStorage for persistence
                        localStorage.setItem('username', res.user.username);
                        localStorage.setItem('userId', res.user.id);
                        localStorage.setItem('userRole', res.user.role);
                        localStorage.setItem('userBalance', res.user.balance);
                        
                        // Close modal properly
                        let modalElement = document.getElementById("loginModal");
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        } else {
                            // Create instance if it doesn't exist
                            modal = new bootstrap.Modal(modalElement);
                            modal.hide();
                        }

                        // Remove backdrop manually (Bootstrap sometimes leaves it)
                        setTimeout(() => {
                            $('.modal-backdrop').remove();
                            $('body').removeClass('modal-open').css('overflow', '');
                        }, 300);

                        // Update UI
                        $("#navLoginBtn").hide();
                        $("#userSection").css('display', 'flex');
                        $("#userEmail").text(res.user.username);

                        // Show admin panel if admin
                        if (res.user.role === 'admin') {
                            $("#adminNavBtn").show();
                        }

                        // Clear form
                        $("#username").val("");
                        $("#password").val("");
                        $("#loginMessage").addClass("hidden");

                        alert("Welcome, " + res.user.username + "!");
                    } else {
                        // Show error message
                        $("#loginMessage").text(res.message || "Invalid username or password").removeClass("hidden");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("AJAX Error:", status, error);
                    console.error("Response:", xhr.responseText);

                    // Try to parse error response
                    try {
                        let errorData = JSON.parse(xhr.responseText);
                        $("#loginMessage").text(errorData.message || "Connection error").removeClass("hidden");
                    } catch (e) {
                        $("#loginMessage").text("Connection error. Please check if login.php exists.").removeClass("hidden");
                    }
                }
            });

        }
        // small helper stubs for actions
        async function previewGame(id) {
            try {
                const res = await fetch('game.php?id=' + encodeURIComponent(id));
                if (!res.ok) throw new Error('Game not found');
                const game = await res.json();

                document.getElementById('previewTitle').innerText = game.title || 'Untitled';
                document.getElementById('previewDesc').innerText = game.description || '';
                document.getElementById('previewPrice').innerText = '$' + (parseFloat(game.price || 0).toFixed(2));
                document.getElementById('previewImage').src = game.image || '';

                // Publisher
                const pubEl = document.getElementById('previewPublisher');
                if (pubEl) pubEl.innerText = game.publisher || 'Unknown';

                // Rating: render star icons and numeric value
                const ratingEl = document.getElementById('previewRating');
                if (ratingEl) {
                    const rating = parseFloat(game.rating || 0);
                    const full = Math.floor(rating);
                    const half = (rating - full) >= 0.5;
                    let stars = '';
                    for (let i = 0; i < 5; i++) {
                        if (i < full) stars += '‚òÖ';
                        else stars += '‚òÜ';
                    }
                    ratingEl.innerHTML = `<span style="color:#f6c94d;font-size:1.05rem;">${stars}</span> <span style="color:#cbd5e1;margin-left:6px;">${rating.toFixed(1)}</span>`;
                }

                // Reviews
                const reviewsEl = document.getElementById('previewReviews');
                if (reviewsEl) {
                    reviewsEl.innerHTML = '';
                    const reviews = Array.isArray(game.reviews) ? game.reviews : [];
                    if (reviews.length === 0) {
                        reviewsEl.innerHTML = '<div class="text-gray-500">No reviews yet.</div>';
                    } else {
                        reviews.forEach(r => {
                            const rRating = parseFloat(r.rating || 0);
                            const rFull = Math.floor(rRating);
                            let rStars = '';
                            for (let i = 0; i < 5; i++) {
                                rStars += (i < rFull) ? '‚òÖ' : '‚òÜ';
                            }
                            const node = document.createElement('div');
                            node.className = 'p-2 rounded bg-slate-700';
                            node.innerHTML = `<div class="d-flex justify-content-between"><div class="fw-bold text-white">${r.user || 'Anonymous'}</div><div style="color:#f6c94d">${rStars} <span style="color:#cbd5e1;margin-left:6px;">${rRating.toFixed(1)}</span></div></div><div class="text-gray-300 mt-1">${r.text || ''}</div>`;
                            reviewsEl.appendChild(node);
                        });
                    }
                }

                // attach add handler (replace previous)
                const previewAddBtn = document.getElementById('previewAddBtn');
                previewAddBtn.onclick = function() { addToCart(game.id || id); };

                let modal = new bootstrap.Modal(document.getElementById('previewModal'));
                modal.show();
            } catch (e) {
                console.error('previewGame error:', e);
                alert('Failed to load game preview.');
            }
        }
        
        async function checkOwnershipForGames() {
            try {
                const [libRes, cartRes] = await Promise.all([fetch('library.php'), fetch('cart.php', { credentials: 'same-origin' })]);
                const libJson = libRes.ok ? await libRes.json() : [];
                const cartJson = cartRes.ok ? await cartRes.json() : {};
                const ownedIds = Array.isArray(libJson) ? libJson.map(Number) : (Array.isArray(libJson.ids) ? libJson.ids.map(Number) : []);
                const cartItems = Array.isArray(cartJson.items) ? cartJson.items : (Array.isArray(cartJson) ? cartJson : []);
                const cartIds = cartItems.map(it => Number(it.id));

                document.querySelectorAll('.add-cart-btn').forEach(btn => {
                    const id = Number(btn.getAttribute('data-id'));
                    if (ownedIds.includes(id)) {
                        btn.disabled = true;
                        btn.innerText = 'Owned';
                        btn.classList.remove('bg-blue-600');
                        btn.classList.add('bg-gray-600');
                    } else if (cartIds.includes(id)) {
                        btn.disabled = true;
                        btn.innerText = 'In Cart';
                        btn.classList.remove('bg-blue-600');
                        btn.classList.add('bg-gray-600');
                    } else {
                        btn.disabled = false;
                        btn.innerText = 'Add to Cart';
                        btn.classList.remove('bg-gray-600');
                        btn.classList.add('bg-blue-600');
                    }
                });
            } catch (e) {
                console.error('checkOwnershipForGames error:', e);
            }
        }

        // Add to cart: fetch game details then POST to cart.php
        //Complete rewrite to use server-side cart -nv
        async function addToCart(id) {
            const username = localStorage.getItem('username');
            const userId = localStorage.getItem('userId');
            if (!username || !userId) {
                alert('Please login to add games to cart');
                showLogin();
                return;
            }
            try {
                // Check owned games on server
                const libRes = await fetch('library.php');
                if (libRes.ok) {
                    const owned = await libRes.json();
                    if (Array.isArray(owned) && owned.map(Number).includes(Number(id))) {
                        alert('You already own this game.');
                        return;
                    }
                }

                // Check server cart for duplicate
                const cartRes = await fetch('cart.php', { credentials: 'same-origin' });
                if (cartRes.ok) {
                    const cartJson = await cartRes.json();
                    const cartItems = Array.isArray(cartJson.items) ? cartJson.items : [];
                    if (cartItems.some(it => Number(it.id) === Number(id))) {
                        alert('This game is already in your cart.');
                        return;
                    }
                }
                // fetch full game record from server
                const gRes = await fetch('game.php?id=' + encodeURIComponent(id));
                if (!gRes.ok) throw new Error('Game not found');
                const game = await gRes.json();

                // prepare item to send
                const item = {
                    id: Number(game.id || id),
                    title: game.title || '',
                    price: Number(game.price || 0),
                    image: game.image || '',
                    description: game.description || '',
                    qty: 1
                };

                const res = await fetch('cart.php', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'add', item: item })
                });
                const data = await res.json();
                if (data.success) {
                    updateCartBadge(data.count || 0);
                    alert('Added "' + item.title + '" to cart');
                } else {
                    throw new Error(data.message || 'Failed to add to cart');
                }
            } catch (err) {
                console.error('Add to cart failed:', err);
                alert('Could not add to cart. See console for details.');
            }
        }

        // Fetch cart from server and update UI badge
        async function getServerCart() {
            try {
                const res = await fetch('cart.php', { credentials: 'same-origin' });
                if (!res.ok) throw new Error('Server cart fetch failed');
                const json = await res.json();
                updateCartBadge(json.count || 0);
            } catch (e) {
                console.error('Failed to read server cart:', e);
                updateCartBadge(0);
            }
        }

        function updateCartBadge(count) {
            const badge = document.getElementById('cartBadge');
            if (!badge) return;
            if (count && count > 0) {
                badge.style.display = 'flex';
                badge.innerText = String(count);
            } else {
                badge.style.display = 'none';
            }
        }

        /* LOGOUT FUNCTION */
        function logout() {
            // Clear localStorage
            localStorage.removeItem('username');
            localStorage.removeItem('userId');
            localStorage.removeItem('userRole');
            
            $.ajax({
                url: "logout.php",
                method: "POST",
                success: function () {
                    $("#userSection").hide();
                    $("#navLoginBtn").show();
                    $("#adminNavBtn").hide();
                    $("#userEmail").text("");
                    alert("You have been logged out");
                },
                error: function () {
                    // Logout locally even if server fails
                    $("#userSection").hide();
                    $("#navLoginBtn").show();
                    $("#adminNavBtn").hide();
                    $("#userEmail").text("");
                    alert("Logged out");
                }
            });
        }
        /* ALLOW ENTER KEY TO SUBMIT */
        $(document).ready(function () {
            $("#username, #password").on("keypress", function (e) {
                if (e.which === 13) { // Enter key
                    login();
                }
            });
        });

        /* AUTO LOAD */
        loadStore();
        getServerCart();

        // RESTORE LOGIN STATE FROM LOCALSTORAGE
        function restoreLoginState() {
            const username = localStorage.getItem('username');
            const userId = localStorage.getItem('userId');
            const userRole = localStorage.getItem('userRole');
            
            if (username && userId) {
                $("#navLoginBtn").hide();
                $("#userSection").css('display', 'flex');
                $("#userEmail").text(username);
                
                if (userRole === 'admin') {
                    $("#adminNavBtn").show();
                }
            }
        }
        
        // Call on page load
        restoreLoginState();

        // SEARCH FUNCTION - Filter games in real-time
        function filterGames() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const gameCards = document.querySelectorAll('#gamesGrid > div');

            gameCards.forEach(card => {
                const title = card.querySelector('h4').textContent.toLowerCase();
                const genre = card.querySelector('p').textContent.toLowerCase();

                const matches = title.includes(searchTerm) || genre.includes(searchTerm);
                card.style.display = matches ? 'block' : 'none';
            });
        }

        // THEME TOGGLE FUNCTION
        function toggleTheme() {
            const html = document.documentElement;
            const themeToggle = document.getElementById('themeToggle');
            const currentTheme = html.getAttribute('data-theme');

            if (currentTheme === 'light') {
                html.removeAttribute('data-theme');
                localStorage.setItem('theme', 'dark');
                themeToggle.innerText = 'üåô';
            } else {
                html.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
                themeToggle.innerText = '‚òÄÔ∏è';
            }
        }

        // LOAD THEME ON PAGE LOAD
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeToggle = document.getElementById('themeToggle');

            if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                themeToggle.innerText = '‚òÄÔ∏è';
            } else {
                themeToggle.innerText = 'üåô';
            }
        }

        // Call loadTheme on page load
        loadTheme();
    </script>
</body>