<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaPlay</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap Modal -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #0f172a 100%);
            min-height: 100vh;
        }

        .card-hover {
            transition: transform 0.3s ease;
        }

        .card-hover:hover {
            transform: scale(1.05);
        }

        .nav-gradient {
            background: linear-gradient(to right, #3b82f6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* FIXED INPUT CLASS */
        .steam-input {
            background: #1b2838 !important;
            border: 1px solid #3b4450 !important;
            color: #c7d5e0 !important;
            padding: 14px 16px !important;
            font-size: 16px !important;
            border-radius: 6px !important;
        }

        .steam-input:focus {
            background: #0f1926 !important;
            border-color: #67c1f5 !important;
            box-shadow: 0 0 6px #67c1f580 !important;
            color: white !important;
        }

        .modal-content {
            background: #1b2838 !important;
            border: 1px solid #2a3f55 !important;
        }

        .modal-header,
        .modal-footer {
            border-color: #2a3f55 !important;
        }

        .modal-footer {
            display: block;
            text-align: center;
        }

        /* LOGIN BUTTON FIXED */
        .login-btn {
            width: 100%;
            padding: 14px 16px;
            background: linear-gradient(to right, #3b82f6, #06b6d4);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 17px;
            transition: 0.2s;
        }

        .login-btn:hover {
            transform: scale(1.03);
            background: linear-gradient(to right, #2563eb, #0ea5e9);
        }
    </style>
</head>


<body class="text-white">

    <!-- Bootstrap CSS (REQUIRED for modal) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Navigation Bar -->
    <nav class="bg-slate-800 bg-opacity-95 border-b border-blue-500 border-opacity-20 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-8">
                    <h1 class="text-2xl font-bold nav-gradient">GameStore</h1>

                    <div class="hidden md:flex space-x-6">
                        <button onclick="showPage('store')"
                            class="nav-btn px-3 py-2 rounded transition text-gray-300 hover:text-white hover:bg-slate-700 bg-blue-600"
                            data-page="store">Store</button>
                        <button onclick="showPage('library')"
                            class="nav-btn px-3 py-2 rounded transition text-gray-300 hover:text-white hover:bg-slate-700"
                            data-page="library">Library</button>
                        <button id="adminNavBtn" onclick="showPage('admin')"
                            class="nav-btn px-3 py-2 rounded transition text-gray-300 hover:text-white hover:bg-slate-700"
                            data-page="admin" style="display:none;">Admin Panel</button>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <div class="relative hidden sm:block">
                        <input type="text" id="searchInput" placeholder="Search games..." onkeyup="filterGames()"
                            class="pl-10 pr-4 py-2 bg-slate-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-64">
                    </div>

                    <button onclick="showPage('cart')"
                        class="relative p-2 text-gray-300 hover:text-white hover:bg-slate-700 rounded-lg transition">
                        <span class="text-2xl">ðŸ›’</span>
                        <span id="cartBadge"
                            class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 items-center justify-center"
                            style="display:none;">0</span>
                    </button>

                    <div id="userSection" class="items-center space-x-3" style="display:none;">
                       <button id="userEmail"
                            class="text-gray-300 hidden sm:inline-flex items-center px-3 py-1 rounded hover:bg-slate-700"
                            type="button" onclick="showPage('profile')"></button>
                        <button onclick="logout()"
                            class="p-2 text-gray-300 hover:text-white hover:bg-slate-700 rounded-lg transition">Logout</button>
                    </div>

                    <button id="navLoginBtn" onclick="showLogin()"
                        class="p-2 text-gray-300 hover:text-white hover:bg-slate-700 rounded-lg transition">
                        Login
                    </button>
                </div>
            </div>
        </div>
    </nav>


    <!-- LOGIN MODAL FIXED -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title text-white">Sign in to NovaPlay</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input id="username" class="steam-input w-full mb-3" placeholder="Username">
                    <input id="password" type="password" class="steam-input w-full" placeholder="Password">

                    <div class="text-gray-400 text-sm mt-3">
                        <p>Admin: admin / admin</p>
                        <p>User: user / user</p>
                    </div>

                    <div id="loginMessage" class="text-red-400 mt-3 hidden">Invalid login</div>
                </div>

                <div class="modal-footer">
                    <!-- data-bs-dismiss="modal"   LAGI COBA REMOVE INI DARI BUTTON LOGIN -->
                    <button class="login-btn" onclick="login()">Login</button>
                </div>

            </div>
        </div>
    </div>
                <!-- PREVIEW MODAL -->
               <div class="modal fade" id="previewModal" tabindex="-1">
                   <div class="modal-dialog modal-dialog-centered">
                       <div class="modal-content">
                           <div class="modal-header">
                               <h5 id="previewTitle" class="modal-title text-white">Game Title</h5>
                               <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                           </div>
                           <div class="modal-body">
                               <img id="previewImage" src="" alt="" class="w-full h-48 object-cover rounded-md mb-3">
                               <p id="previewDesc" class="text-gray-300 mb-2"></p>
                               <p id="previewPrice" class="font-bold text-blue-400"></p>
                           </div>
                           <div class="modal-footer">
                               <button id="previewAddBtn" class="login-btn">Add to Cart</button>
                           </div>
                       </div>
                   </div>
               </div>
    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Store Page -->
        <div id="storePage" class="page">
            <h2 class="text-3xl font-bold text-white mb-8">Featured Games</h2>

            <!-- Grid of full cards: 2 columns on mobile, 4 on md+ -->
            <div id="gamesTable" class="bg-slate-800 rounded-xl p-4">
                <div id="gamesGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4 items-stretch">
                    <!-- cards injected here -->
                </div>
            </div>
        </div>

        <!-- Library Page -->
        <div id="libraryPage" class="page" style="display:none;">
            <h2 class="text-3xl font-bold text-white mb-8">My Library</h2>
            <div class="text-center py-20">
                <p class="text-gray-400 text-lg">Your purchased games will appear here</p>
            </div>
        </div>

        <!-- Cart Page -->
        <div id="cartPage" class="page" style="display:none;">
            <h2 class="text-3xl font-bold text-white mb-8">Shopping Cart</h2>
            <div id="cartItems"></div>
            <div id="emptyCart" class="text-center py-20">
                <div class="text-6xl mb-4">ðŸ›’</div>
                <p class="text-gray-400 text-lg">Your cart is empty</p>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="adminPage" class="page" style="display:none;">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-white">Admin Panel</h2>
                <button onclick="showAddGameForm()"
                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition flex items-center space-x-2">
                    <span>âž•</span>
                    <span>Add Game</span>
                </button>
            </div>

            <div id="gameForm" class="bg-slate-800 rounded-xl p-6 mb-8" style="display:none;">
                <h3 id="formTitle" class="text-xl font-bold text-white mb-4">Add New Game</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-300 mb-2">Title</label>
                        <input type="text" id="gameTitle"
                            class="w-full px-4 py-2 bg-slate-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-300 mb-2">Price</label>
                            <input type="number" id="gamePrice" step="0.01"
                                class="w-full px-4 py-2 bg-slate-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-gray-300 mb-2">Genre</label>
                            <input type="text" id="gameGenre"
                                class="w-full px-4 py-2 bg-slate-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-300 mb-2">Description</label>
                        <textarea id="gameDescription" rows="3"
                            class="w-full px-4 py-2 bg-slate-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <div>
                        <label class="block text-gray-300 mb-2">Image URL</label>
                        <input type="url" id="gameImage"
                            class="w-full px-4 py-2 bg-slate-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="flex space-x-3">
                        <button onclick="saveGame()"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition">Save
                            Game</button>
                        <button onclick="cancelGameForm()"
                            class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg transition">Cancel</button>
                    </div>
                </div>
            </div>

            <div id="adminGamesList" class="space-y-4"></div>
        </div>
    </div>


    <!-- Bootstrap JS (REQUIRED for modal) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Modal Trigger -->
    <script>
        function showLogin() {
            let modal = new bootstrap.Modal(document.getElementById("loginModal"));
            modal.show();
        }
        // Showpage function to switch between pages
        function showPage(page) {
            const pageIds = ['store', 'library', 'cart', 'admin','profile'];
            // Toggle page visibility

            if (page === 'library') {
                window.location.href = 'library.html';
                return;
            }
            if (page === 'cart') {
                window.location.href = 'Cart.html';
                return;
            }
            if (page === 'profile') {
                window.location.href = 'profile.html';
                return;
            }

            pageIds.forEach(p => {
                const el = document.getElementById(p + 'Page');
                if (!el) return;
                el.style.display = (p === page) ? 'block' : 'none';
            });

            // Update nav button active styles
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-300');
            });
            const activeBtn = document.querySelector(`.nav-btn[data-page="${page}"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-blue-600', 'text-white');
                activeBtn.classList.remove('text-gray-300');
            }

            // Page-specific actions
            if (page === 'store') {
                loadStore();
            }



            // Scroll to top for better UX
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }        
        /* LOAD GAME DUMMY VIA AJAX */
        function loadStore() {
            $.ajax({
                url: "game.php",
                method: "GET",
                dataType: "json",
                success: function (res) {
                    $("#gamesGrid").empty();

                    res.forEach(g => {
                        // each row is a responsive "card" â€” full card on mobile, grid row on md+
                        $("#gamesGrid").append(`
                        <div class="bg-slate-700 rounded-lg p-4 flex flex-col h-full card-hover">
                            <img src="${g.image || ''}" alt="${g.title}" class="w-full h-36 object-cover rounded-md mb-3">
                            <h4 class="text-lg font-semibold text-white mb-1">${g.title}</h4>
                            <p class="text-sm text-gray-400 mb-2">${g.genre || ''}</p>
                            <p class="text-blue-400 font-bold mb-3">$${parseFloat(g.price || 0).toFixed(2)}</p>
                            <div class="mt-auto flex items-center justify-between">
                                <button onclick="previewGame('${encodeURIComponent(g.title)}')" class="px-3 py-1 bg-slate-600 hover:bg-slate-500 rounded text-sm">Preview</button>
                                <button onclick="addToCart(${g.id || 0})" class="px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded text-sm text-white">Add to Cart</button>
                            </div>
                        </div>
                `);
                    });

                    checkOwnershipForGames();
                    },
                error: function (xhr, status, err) {
                    console.error("Failed to load games:", status, err);
                    $("#gamesGrid").html('<div class="text-center text-red-400 col-span-2 md:col-span-4">Could not load games. Check games.php</div>');
                }
            });
        }
        
        /* DATA LOGIN VIA AJAX */
        function login() {
            let username = $("#username").val().trim();
            let password = $("#password").val().trim();

            // Validate input
            if (!username || !password) {
                $("#loginMessage").text("Please enter username and password").removeClass("hidden");
                return;
            }



            // Hide previous error messages
            $("#loginMessage").addClass("hidden");

            $.ajax({
                url: "login.php",
                method: "POST",
                dataType: "json",
                data: {
                    username: username,
                    password: password
                },
                success: function (res) {
                    console.log("Login Response:", res); // Debug

                    if (res.success) {
                        // Close modal properly
                        let modalElement = document.getElementById("loginModal");
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        } else {
                            // Create instance if it doesn't exist
                            modal = new bootstrap.Modal(modalElement);
                            modal.hide();
                        }

                        // Remove backdrop manually (Bootstrap sometimes leaves it)
                        setTimeout(() => {
                            $('.modal-backdrop').remove();
                            $('body').removeClass('modal-open').css('overflow', '');
                        }, 300);

                        // Update UI
                        $("#navLoginBtn").hide();
                        $("#userSection").css('display', 'flex');
                        $("#userEmail").text(res.user.username);

                        // Show admin panel if admin
                        if (res.user.role === 'admin') {
                            $("#adminNavBtn").show();
                        }

                        // Clear form
                        $("#username").val("");
                        $("#password").val("");
                        $("#loginMessage").addClass("hidden");

                        alert("Welcome, " + res.user.username + "!");
                    } else {
                        // Show error message
                        $("#loginMessage").text(res.message || "Invalid username or password").removeClass("hidden");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("AJAX Error:", status, error);
                    console.error("Response:", xhr.responseText);

                    // Try to parse error response
                    try {
                        let errorData = JSON.parse(xhr.responseText);
                        $("#loginMessage").text(errorData.message || "Connection error").removeClass("hidden");
                    } catch (e) {
                        $("#loginMessage").text("Connection error. Please check if login.php exists.").removeClass("hidden");
                    }
                }
            });

        }
        // small helper stubs for actions
        async function previewGame(id) {
            try {
                const res = await fetch('game.php?id=' + encodeURIComponent(id));
                if (!res.ok) throw new Error('Game not found');
                const game = await res.json();

                document.getElementById('previewTitle').innerText = game.title || 'Untitled';
                document.getElementById('previewDesc').innerText = game.description || '';
                document.getElementById('previewPrice').innerText = '$' + (parseFloat(game.price || 0).toFixed(2));
                document.getElementById('previewImage').src = game.image || '';

                // attach add handler (replace previous)
                const previewAddBtn = document.getElementById('previewAddBtn');
                previewAddBtn.onclick = function() { addToCart(game.id || id); };

                let modal = new bootstrap.Modal(document.getElementById('previewModal'));
                modal.show();
            } catch (e) {
                console.error('previewGame error:', e);
                alert('Failed to load game preview.');
            }
        }
        
        async function checkOwnershipForGames() {
            try {
                const [libRes, cartRes] = await Promise.all([fetch('library.php'), fetch('cart.php')]);
                const libJson = libRes.ok ? await libRes.json() : [];
                const cartJson = cartRes.ok ? await cartRes.json() : {};
                const ownedIds = Array.isArray(libJson) ? libJson.map(Number) : (Array.isArray(libJson.ids) ? libJson.ids.map(Number) : []);
                const cartItems = Array.isArray(cartJson.items) ? cartJson.items : (Array.isArray(cartJson) ? cartJson : []);
                const cartIds = cartItems.map(it => Number(it.id));

                document.querySelectorAll('.add-cart-btn').forEach(btn => {
                    const id = Number(btn.getAttribute('data-id'));
                    if (ownedIds.includes(id)) {
                        btn.disabled = true;
                        btn.innerText = 'Owned';
                        btn.classList.remove('bg-blue-600');
                        btn.classList.add('bg-gray-600');
                    } else if (cartIds.includes(id)) {
                        btn.disabled = true;
                        btn.innerText = 'In Cart';
                        btn.classList.remove('bg-blue-600');
                        btn.classList.add('bg-gray-600');
                    } else {
                        btn.disabled = false;
                        btn.innerText = 'Add to Cart';
                        btn.classList.remove('bg-gray-600');
                        btn.classList.add('bg-blue-600');
                    }
                });
            } catch (e) {
                console.error('checkOwnershipForGames error:', e);
            }
        }

        // Add to cart: fetch game details then POST to cart.php
        //Complete rewrite to use server-side cart -nv
        async function addToCart(id) {
            try {
                // Check owned games on server
                const libRes = await fetch('library.php');
                if (libRes.ok) {
                    const owned = await libRes.json();
                    if (Array.isArray(owned) && owned.map(Number).includes(Number(id))) {
                        alert('You already own this game.');
                        return;
                    }
                }

                // Check server cart for duplicate
                const cartRes = await fetch('cart.php');
                if (cartRes.ok) {
                    const cartJson = await cartRes.json();
                    const cartItems = Array.isArray(cartJson.items) ? cartJson.items : [];
                    if (cartItems.some(it => Number(it.id) === Number(id))) {
                        alert('This game is already in your cart.');
                        return;
                    }
                }
                // fetch full game record from server
                const gRes = await fetch('game.php?id=' + encodeURIComponent(id));
                if (!gRes.ok) throw new Error('Game not found');
                const game = await gRes.json();

                // prepare item to send
                const item = {
                    id: Number(game.id || id),
                    title: game.title || '',
                    price: Number(game.price || 0),
                    image: game.image || '',
                    description: game.description || '',
                    qty: 1
                };

                const res = await fetch('cart.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'add', item: item })
                });
                const data = await res.json();
                if (data.success) {
                    updateCartBadge(data.count || 0);
                    alert('Added "' + item.title + '" to cart');
                } else {
                    throw new Error(data.message || 'Failed to add to cart');
                }
            } catch (err) {
                console.error('Add to cart failed:', err);
                alert('Could not add to cart. See console for details.');
            }
        }

        // Fetch cart from server and update UI badge
        async function getServerCart() {
            try {
                const res = await fetch('cart.php');
                if (!res.ok) throw new Error('Server cart fetch failed');
                const json = await res.json();
                updateCartBadge(json.count || 0);
            } catch (e) {
                console.error('Failed to read server cart:', e);
                updateCartBadge(0);
            }
        }

        function updateCartBadge(count) {
            const badge = document.getElementById('cartBadge');
            if (!badge) return;
            if (count && count > 0) {
                badge.style.display = 'flex';
                badge.innerText = String(count);
            } else {
                badge.style.display = 'none';
            }
        }

        /* LOGOUT FUNCTION */
        function logout() {
            $.ajax({
                url: "logout.php",
                method: "POST",
                success: function () {
                    $("#userSection").hide();
                    $("#navLoginBtn").show();
                    $("#adminNavBtn").hide();
                    $("#userEmail").text("");
                    alert("You have been logged out");
                },
                error: function () {
                    // Logout locally even if server fails
                    $("#userSection").hide();
                    $("#navLoginBtn").show();
                    $("#adminNavBtn").hide();
                    $("#userEmail").text("");
                    alert("Logged out");
                }
            });
        }
        /* ALLOW ENTER KEY TO SUBMIT */
        $(document).ready(function () {
            $("#username, #password").on("keypress", function (e) {
                if (e.which === 13) { // Enter key
                    login();
                }
            });
        });

        /* AUTO LOAD */
        loadStore();
        getServerCart();
    </script>
</body>