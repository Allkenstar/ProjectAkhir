<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NovaPlay - Cart</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body{
    background: linear-gradient(135deg,#0f172a 0%,#1e3a8a 50%,#0f172a 100%);
    color:#fff;
    min-height:100vh;
    padding-top:80px
  }

  /* ITEM CARD RESPONSIVE */
  .item-card{
    background:#1e293b;
    border-radius:12px;
    padding:12px;
    display:flex;
    gap:12px;
    align-items:center;
    flex-wrap: wrap;  /* BIAR TURUN SAAT HP */
  }

  .thumb{
    width:100px;
    height:70px;
    object-fit:cover;
    border-radius:6px;
  }

  /* MOBILE OPTIMIZED */
  @media(max-width: 576px){
    .item-card{
      flex-direction: column;      /* item jadi vertical */
      align-items:flex-start;
      text-align:left;
    }

    .thumb{
      width:100%;
      height:150px;
    }

    .item-card button{
      width:100%;
      margin-top:10px;
    }
  }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container">
    <a class="navbar-brand" href="store.html">NovaPlay</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav3">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="nav3">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="store.html">Store</a></li>
        <li class="nav-item"><a class="nav-link" href="library.html">Library</a></li>
        <li class="nav-item"><a class="nav-link active" href="cart.html">Cart</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="container py-6">
  <h1 class="mb-4">Your Cart</h1>

  <div id="cartList" class="space-y-3 mb-4"></div>

  <div id="cartSummary" class="bg-slate-800 p-4 rounded-lg">
    <div class="d-flex justify-content-between">
      <div>Total:</div>
      <div id="totalPrice" class="fw-bold text-blue-400">$0.00</div>
    </div>
    <div class="mt-3 d-flex gap-2 flex-wrap">
      <button class="btn btn-success flex-fill" onclick="checkout()">Checkout (Add to Library)</button>
      <button class="btn btn-outline-light flex-fill" onclick="clearCart()">Clear</button>
    </div>
  </div>
</main>

<script>
async function getCart() {
    const res = await fetch('cart.php');
    if (!res.ok) throw new Error('Failed to fetch cart: ' + res.status);
    const json = await res.json();
    return Array.isArray(json.items) ? json.items : [];
}

// Replace entire cart on server: clear then add items
async function setCart(items) {
    // clear server cart
    await fetch('cart.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'clear' })
    });

    // add items (if any)
    for (const it of items || []) {
        await fetch('cart.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'add', item: it })
        });
    }
}

// Return Promise<Array>
async function getLibrary() {
    const res = await fetch('library.php');
    if (!res.ok) throw new Error('Failed to fetch library: ' + res.status);
    const json = await res.json();
    return Array.isArray(json) ? json : [];
}

// Overwrite server library (POST ids array)
async function setLibrary(ids) {
    const res = await fetch('library.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: ids })
    });
    const json = await res.json();
    if (!res.ok || !json.success) throw new Error('Failed to set library: ' + (json.message || res.status));
    return json.library;
}

async function renderCart(){
  const list = document.getElementById('cartList');
  const totalPrice = document.getElementById('totalPrice');
  list.innerHTML = '';

    try {
        const cart = await getCart();
        if (!cart || cart.length === 0) {
            list.innerHTML = '<div class="text-gray-400">Cart is empty.</div>';
            totalPrice.innerText = '$0.00';
            return;
        }

        let total = 0;
        cart.forEach((it, idx) => {
            total += parseFloat(it.price || 0) * (parseInt(it.qty || 1));
            const div = document.createElement('div');
            div.className = 'item-card';
            div.innerHTML = `
              <img class="thumb" src="${it.image || ''}" alt="">
              <div class="flex-grow-1 w-100">
                <div class="fw-bold">${it.title || 'Untitled'}</div>
                <div class="text-gray-400">$${parseFloat(it.price || 0).toFixed(2)} Ã— ${it.qty || 1}</div>
              </div>
              <div class="w-100 w-sm-auto text-end">
                <button class="btn btn-sm btn-outline-light" onclick="removeItem(${idx})">Remove</button>
              </div>
            `;
            list.appendChild(div);
        });
        totalPrice.innerText = '$' + total.toFixed(2);
    } catch (e) {
        console.error('renderCart error:', e);
        list.innerHTML = '<div class="text-red-400">Failed to load cart.</div>';
        totalPrice.innerText = '$0.00';
    }
}

async function removeItem(idx){
  try {
    const cart = await getCart();
    const item = cart[idx];
    if (!item || !item.id) throw new Error('Item not found');
    await fetch('cart.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'remove', id: item.id })
    });
    await renderCart();
  } catch(e){
        console.error('removeItem failed:', e);
        alert('Failed to remove item.');
  }
}

async function clearCart(){
  try {
        await fetch('cart.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'clear' })
        });
        await renderCart();
    } catch (e) {
        console.error('clearCart failed:', e);
        alert('Failed to clear cart.');
    }
}

async function checkout(){
  try {
        const cart = await getCart();
        if (!cart || cart.length === 0) { alert('Cart is empty'); return; }

        const ids = cart.map(it => Number(it.id));

    const libRes = await fetch('library.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ids: ids })
    });
    const libJson = await libRes.json();
    if (!libRes.ok || !libJson.success) throw new Error(libJson.message || 'Library save failed');

        // clear server cart
        await fetch('cart.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'clear' })
        });

        // redirect to library
        window.location.href = 'library.html';
    } catch (e) {
        console.error('Checkout failed:', e);
        alert('Checkout failed. See console for details.');
    }
}

document.addEventListener('DOMContentLoaded', function(){ renderCart(); });
</script>

</body>
</html>
