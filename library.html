<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NovaPlay - Library</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  /* --- BACKGROUND UTAMA (Sesuai Request) --- */
  body { 
    background: linear-gradient(135deg,#0f172a 0%,#1e3a8a 50%,#0f172a 100%); 
    color:#fff; 
    min-height:100vh; 
    padding-top:80px;
    font-family: system-ui, -apple-system, sans-serif;
  }

  /* --- CARD STYLE (Dipercantik) --- */
  .steam-card { 
    background: rgba(30, 41, 59, 0.7); 
    backdrop-filter: blur(5px);
    border-radius: 12px; 
    overflow: hidden; 
    box-shadow: 0 6px 16px rgba(0,0,0,.35);
    border: 1px solid rgba(255,255,255,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  
  .steam-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.5);
    border-color: rgba(96, 165, 250, 0.4);
  }

  .steam-img { 
    width: 100%; 
    height: 160px; 
    object-fit: cover;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }

  /* --- STATS DASHBOARD --- */
  .stats-box {
    background: rgba(15, 23, 42, 0.6);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid rgba(255,255,255,0.1);
    margin-bottom: 30px;
  }
  .stat-val { font-size: 1.8rem; font-weight: 800; color: #60a5fa; }
  .stat-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; }

  /* --- BUTTONS --- */
  .btn-play {
    background: linear-gradient(135deg, #10b981, #059669);
    border: none; color: white; font-weight: 600; width: 100%;
  }
  .btn-play:hover { filter: brightness(1.1); }
  
  .btn-remove {
    background: transparent; border: 1px solid #ef4444; color: #ef4444; width: 100%;
  }
  .btn-remove:hover { background: #ef4444; color: white; }

  .fade-in { 
    animation: fadeIn 0.3s ease-in; 
  }
  
  @keyframes fadeIn { 
    from { opacity:0; transform:translateY(10px); } 
    to { opacity:1; transform:translateY(0); } 
  }

  .loading-spinner {
    border: 3px solid rgba(255,255,255,0.1);
    border-top: 3px solid #60a5fa;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top" style="background: rgba(15,23,42,0.95); border-bottom: 1px solid rgba(255,255,255,0.1);">
  <div class="container">
    <a class="navbar-brand fw-bold" href="home.html" style="color:#60a5fa">NovaPlay</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav2">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav2">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="home.html">Store</a></li>
        <li class="nav-item"><a class="nav-link active" href="library.html">Library</a></li>
        <li class="nav-item"><a class="nav-link" href="cart.html">Cart</a></li>
      </ul>
      <div class="d-flex align-items-center gap-3">
        <div class="text-end d-none d-md-block">
            <div class="fw-bold text-white" id="username">Gamer123</div>
            <small class="text-success">Online</small>
        </div>
        <button onclick="logout()" class="btn btn-sm btn-outline-light">Logout</button>
        <div class="bg-blue-600 rounded-circle d-flex align-items-center justify-content-center fw-bold" style="width:35px; height:35px;" id="userAvatar">G</div>
      </div>
    </div>
  </div>
</nav>

<main class="container py-4">
  
  <div class="stats-box">
    <div class="row text-center">
      <div class="col-4 border-end border-secondary">
        <div class="stat-val" id="total-games">0</div>
        <div class="stat-label">Games Owned</div>
      </div>
      <div class="col-4 border-end border-secondary">
        <div class="stat-val" id="total-hours">0h</div>
        <div class="stat-label">Total Playtime</div>
      </div>
      <div class="col-4">
        <div class="stat-val text-success">Active</div>
        <div class="stat-label">Account Status</div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold m-0">My Games Collection</h2>
    <input type="text" id="searchLib" placeholder="Search library..." class="form-control form-control-sm bg-dark text-white border-secondary" style="width: 200px;">
  </div>

  <div id="libraryGrid" class="row g-4">
    <div class="col-12 text-center py-5">
      <div class="loading-spinner mx-auto"></div>
      <p class="text-white-50 mt-3">Loading your library...</p>
    </div>
  </div>
</main>

<script>
// --- GLOBAL VARIABLES ---
let allGames = [];
let ownedGames = [];
let gamePlaytimes = {}; // Store playtime for each game

// --- FUNGSI UTAMA ---

// Load games from server
async function loadGames() {
  try {
    // Fetch all games from game.php
    const gamesResponse = await fetch('game.php');
    if (!gamesResponse.ok) throw new Error('Failed to fetch games');
    allGames = await gamesResponse.json();
    
    // Fetch library IDs from library.php
    const libraryResponse = await fetch('library.php');
    if (!libraryResponse.ok) throw new Error('Failed to fetch library');
    const libraryData = await libraryResponse.json();
    
    // Handle different response formats
    let libraryIds = [];
    if (Array.isArray(libraryData)) {
      libraryIds = libraryData.map(Number);
    } else if (libraryData.library && Array.isArray(libraryData.library)) {
      libraryIds = libraryData.library.map(Number);
    }
    
    // Load playtimes from localStorage
    const savedPlaytimes = localStorage.getItem('gamePlaytimes');
    if (savedPlaytimes) {
      gamePlaytimes = JSON.parse(savedPlaytimes);
    }
    
    // Filter owned games
    ownedGames = allGames.filter(g => libraryIds.includes(Number(g.id)));
    
    // Render library
    renderLibrary(ownedGames);
    updateStats(ownedGames);
    
  } catch (err) {
    console.error('Error loading games:', err);
    showError('Unable to load library. Please try again later.');
  }
}

// Render library to HTML
function renderLibrary(games) {
  const grid = document.getElementById('libraryGrid');
  grid.innerHTML = '';

  if (games.length === 0) {
    grid.innerHTML = `
      <div class="col-12 text-center py-5">
        <div class="text-white-50 display-1 mb-3">üìÇ</div>
        <h3 class="text-white">Library is Empty</h3>
        <p class="text-white-50">Visit the Store to add games to your collection.</p>
        <a href="home.html" class="btn btn-primary mt-2">Go to Store</a>
      </div>`;
    return;
  }

  games.forEach(g => {
    // Get playtime for this game, or generate random if not exists
    if (!gamePlaytimes[g.id]) {
      gamePlaytimes[g.id] = Math.floor(Math.random() * 100) + 1;
      localStorage.setItem('gamePlaytimes', JSON.stringify(gamePlaytimes));
    }
    const hours = gamePlaytimes[g.id];

    const col = document.createElement('div');
    col.className = 'col-12 col-sm-6 col-md-4 col-xl-3 fade-in';
    col.innerHTML = `
      <div class="steam-card">
        <div class="position-relative">
          <img class="steam-img" src="${g.image}" alt="${g.title}" onerror="this.src='https://via.placeholder.com/300x160?text=No+Image'">
          <span class="position-absolute top-0 end-0 m-2 badge bg-success">OWNED</span>
        </div>
        <div class="p-3 d-flex flex-column flex-grow-1">
          <h5 class="fw-bold mb-1 text-truncate" title="${g.title}">${g.title}</h5>
          <div class="text-white-50 small mb-3">${g.genre || 'Unknown'}</div>
          
          <div class="d-flex justify-content-between align-items-center mb-3 small text-white-50 bg-black/20 p-2 rounded">
            <span>Playtime:</span>
            <span class="text-white">${hours}h</span>
          </div>

          <div class="mt-auto d-flex gap-2">
            <button class="btn btn-sm btn-play rounded" onclick="playGame(this, '${g.title.replace(/'/g, "\\'")}', ${g.id})">
              ‚ñ∂ Play
            </button>
            <button class="btn btn-sm btn-remove rounded" onclick="removeFromLibrary(${g.id})">
              ‚úï
            </button>
          </div>
        </div>
      </div>`;
    grid.appendChild(col);
  });
}

// Update stats dashboard
function updateStats(games) {
  document.getElementById('total-games').innerText = games.length;
  
  // Calculate total hours from saved playtimes
  let totalHours = 0;
  games.forEach(g => {
    totalHours += gamePlaytimes[g.id] || 0;
  });
  
  document.getElementById('total-hours').innerText = totalHours + 'h';
}

// Remove game from library
async function removeFromLibrary(id) {
  if (!confirm('Are you sure you want to remove this game from your library?')) return;
  
  try {
    // Fetch current library
    const response = await fetch('library.php');
    if (!response.ok) throw new Error('Failed to fetch library');
    
    const libraryData = await response.json();
    let currentIds = [];
    
    if (Array.isArray(libraryData)) {
      currentIds = libraryData.map(Number);
    } else if (libraryData.library && Array.isArray(libraryData.library)) {
      currentIds = libraryData.library.map(Number);
    }
    
    // Remove the game ID
    const updatedIds = currentIds.filter(gameId => Number(gameId) !== Number(id));
    
    // Update on server
    const updateResponse = await fetch('library.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ids: updatedIds })
    });
    
    if (!updateResponse.ok) throw new Error('Failed to update library');
    
    const result = await updateResponse.json();
    
    if (result.success) {
      // Reload library
      await loadGames();
      showNotification('Game removed from library', 'success');
    } else {
      throw new Error(result.message || 'Failed to remove game');
    }
    
  } catch (err) {
    console.error('Error removing game:', err);
    showNotification('Failed to remove game. Please try again.', 'error');
  }
}

// Play game simulation
function playGame(btn, title, gameId) {
  const originalText = btn.innerHTML;
  btn.innerHTML = 'Launching...';
  btn.classList.add('disabled');
  
  setTimeout(() => {
    showNotification(`Starting game: ${title}`, 'info');
    btn.innerHTML = 'Running';
    btn.style.background = '#eab308';
    
    // Increment playtime
    if (gamePlaytimes[gameId]) {
      gamePlaytimes[gameId] += 1;
      localStorage.setItem('gamePlaytimes', JSON.stringify(gamePlaytimes));
      updateStats(ownedGames);
    }
    
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.classList.remove('disabled');
      btn.style.background = '';
    }, 3000);
  }, 1000);
}

// Search functionality
document.getElementById('searchLib').addEventListener('keyup', (e) => {
  const term = e.target.value.toLowerCase();
  const filtered = ownedGames.filter(g => 
    g.title.toLowerCase().includes(term) || 
    (g.genre && g.genre.toLowerCase().includes(term))
  );
  renderLibrary(filtered);
});

// Show error message
function showError(message) {
  const grid = document.getElementById('libraryGrid');
  grid.innerHTML = `
    <div class="col-12 text-center py-5">
      <div class="text-danger display-1 mb-3">‚ö†Ô∏è</div>
      <h3 class="text-white">Error</h3>
      <p class="text-white-50">${message}</p>
      <button class="btn btn-primary mt-2" onclick="loadGames()">Retry</button>
    </div>`;
}

// Show notification
function showNotification(message, type = 'info') {
  const colors = {
    success: '#10b981',
    error: '#ef4444',
    info: '#60a5fa'
  };
  
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 100px;
    right: 20px;
    background: ${colors[type]};
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 9999;
    animation: slideIn 0.3s ease-out;
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease-out';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Load user info from localStorage if available
function loadUserInfo() {
  const username = localStorage.getItem('username');
  if (username) {
    document.getElementById('username').textContent = username;
    document.getElementById('userAvatar').textContent = username.charAt(0).toUpperCase();
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
  const username = localStorage.getItem('username');
  const userId = localStorage.getItem('userId');
  
  if (!username || !userId) {
    alert('Please login to view your library');
    window.location.href = 'home.html';
    return;
  }
  
  loadUserInfo();
  loadGames();
});

// Add animations
const style = document.createElement('style');
style.innerHTML = `
  @keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
  }
`;
document.head.appendChild(style);

// Logout function
function logout() {
  localStorage.removeItem('username');
  localStorage.removeItem('userId');
  localStorage.removeItem('userRole');
  alert('You have been logged out');
  window.location.href = 'home.html';
}
</script>

</body>
</html>